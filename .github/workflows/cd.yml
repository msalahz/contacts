name: Deployment

on:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  check-ci-status:
    name: Wait for CI Success
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
    steps:
      - name: Wait for CI completion and verify success
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitMinutes = 2;
            const pollIntervalSeconds = 30;
            const maxAttempts = (maxWaitMinutes * 60) / pollIntervalSeconds;

            let attempts = 0;

            while (attempts < maxAttempts) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'ci.yml',
                branch: 'main',
                per_page: 1
              });

              if (runs.total_count === 0) {
                core.setFailed('No CI runs found on main branch');
                return;
              }

              const latestRun = runs.workflow_runs[0];
              console.log(`CI run ${latestRun.id} status: ${latestRun.status}, conclusion: ${latestRun.conclusion}`);

              // If completed, check the conclusion
              if (latestRun.status === 'completed') {
                if (latestRun.conclusion === 'success') {
                  console.log('✅ CI workflow completed successfully. Proceeding with deployment.');
                  return;
                } else {
                  core.setFailed(`❌ CI workflow failed with conclusion: ${latestRun.conclusion}. Deployment blocked.`);
                  return;
                }
              }

              // If still in progress, wait and retry
              if (['in_progress', 'queued', 'requested'].includes(latestRun.status)) {
                attempts++;
                console.log(`⏳ CI workflow is ${latestRun.status}. Waiting ${pollIntervalSeconds}s... (${attempts}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, pollIntervalSeconds * 1000));
              } else {
                core.setFailed(`❌ Unexpected CI workflow status: ${latestRun.status}`);
                return;
              }
            }

            core.setFailed(`⏱️ Timeout: CI workflow did not complete within ${maxWaitMinutes} minutes`);

  deploy:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: check-ci-status
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Netlify
        run: pnpm install netlify-cli -g

      - name: Deploy to Netlify
        id: netlify_deploy
        run: |
          prod_flag=""
          if [ "$BRANCH_NAME" = "main" ]; then prod_flag="--prod"; fi
          netlify deploy \
            --dir dist \
            --site ${{ secrets.NETLIFY_SITE_ID }} \
            --auth ${{ secrets.NETLIFY_API_TOKEN }} \
            $prod_flag
